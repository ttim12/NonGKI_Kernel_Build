name: Build SukiSU for Mi8SE (ColorOS Fix)
on:
  workflow_dispatch:

jobs:
  build:
    name: Build Kernel
    runs-on: ubuntu-latest
    env:
      # 小米8SE (Sirius) 专用配置
      KERNEL_SOURCE: 'https://github.com/SakuraKyuo/android_kernel_xiaomi_sdm710'
      KERNEL_SOURCE_BRANCH: '13.0'
      KERNEL_DEFCONFIG: 'vendor/sirius_perf_defconfig'
      KERNEL_IMAGE_NAME: 'Image.gz-dtb'
      ARCH: 'arm64'
      CLANG_URL: 'https://github.com/kdrag0n/proton-clang/releases/download/20201217/proton_clang-20201217.tar.zst'

    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Setup Build Environment
      run: |
        sudo apt-get update
        sudo apt-get install -y bc bison build-essential ccache curl flex g++-multilib gcc-multilib git gnupg gperf imagemagick lib32ncurses5-dev lib32readline-dev lib32z1-dev liblz4-tool libncurses5 libncurses5-dev libsdl1.2-dev libssl-dev libwxgtk3.0-gtk3-dev libxml2 libxml2-utils lzop pngcrush rsync schedtool squashfs-tools xsltproc zip zlib1g-dev

    - name: Download Clang Toolchain
      run: |
        mkdir clang
        cd clang
        wget -q $CLANG_URL
        tar -I zstd -xf proton_clang-*.tar.zst

    - name: Clone Kernel Source
      run: |
        git clone --depth=1 -b $KERNEL_SOURCE_BRANCH $KERNEL_SOURCE kernel_source

    # ===【核心修改：伪造内核版本号】===
    # 这一步是为了骗过 ColorOS 的 WiFi 驱动检查
    - name: Force Kernel Version (Spoofing)
      run: |
        cd kernel_source
        echo "正在修改版本号以匹配 ColorOS..."
        # 强制修改 Makefile，让编译出来的内核版本号严格匹配您截图中的指纹
        sed -i 's/^EXTRAVERSION =.*/EXTRAVERSION = -perf-g30e2137d229f/' Makefile
        # 清除干扰
        touch .scmversion

    - name: Integrate SukiSU (Non-GKI)
      run: |
        cd kernel_source
        echo "正在植入 SukiSU..."
        curl -LSs "https://raw.githubusercontent.com/SukiSU-Ultra/SukiSU-Ultra/main/kernel/setup.sh" | bash -s nongki

    - name: Build Kernel
      run: |
        cd kernel_source
        export PATH=$GITHUB_WORKSPACE/clang/bin:$PATH
        # 清理
        make O=out ARCH=arm64 clean
        make O=out ARCH=arm64 mrproper
        
        # 生成配置
        make O=out ARCH=arm64 $KERNEL_DEFCONFIG

        # 二次确认版本号没有被 .config 覆盖
        cd out
        sed -i 's/CONFIG_LOCALVERSION=.*/CONFIG_LOCALVERSION=""/' .config
        cd ..

        # 编译开始
        make -j$(nproc --all) O=out ARCH=arm64 CC=clang CLANG_TRIPLE=aarch64-linux-gnu- CROSS_COMPILE=aarch64-linux-gnu- CROSS_COMPILE_ARM32=arm-linux-gnueabi- $KERNEL_IMAGE_NAME

    - name: Package AnyKernel3
      run: |
        git clone https://github.com/osm0sis/AnyKernel3
        cp kernel_source/out/arch/arm64/boot/$KERNEL_IMAGE_NAME AnyKernel3/
        cd AnyKernel3
        # 打包
        zip -r9 SukiSU-Mi8SE-Fix.zip * -x .git README.md *placeholder

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: SukiSU-Kernel-Mi8SE-Fix
        path: AnyKernel3/*.zip
